<link rel="stylesheet" href="{{ 'section-product.css' | asset_url }}" media="print" onload="this.media='all'">
<noscript>{{ 'section-product.css' | asset_url | stylesheet_tag }}</noscript>

<div class="product-page">
  <div class="page-width">
    <div class="product-grid">
      <!-- Product Images -->
      <div class="product-images">
        <div class="product-image-main">
          {% if product.featured_image %}
            <img src="{{ product.featured_image | image_url: width: 600 }}" 
                 alt="{{ product.featured_image.alt | default: product.title }}"
                 class="product-image-primary">
          {% else %}
            <div class="product-image-placeholder">
              <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21,15 16,10 5,21"></polyline>
              </svg>
            </div>
          {% endif %}
        </div>
        
        {% if product.images.size > 1 %}
          <div class="product-image-thumbnails">
            {% for image in product.images limit: 4 %}
              <button class="product-thumbnail {% if forloop.first %}active{% endif %}" 
                      onclick="changeMainImage('{{ image | image_url: width: 600 }}')">
                <img src="{{ image | image_url: width: 150 }}" alt="{{ image.alt | default: product.title }}">
              </button>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <!-- Product Info -->
      <div class="product-info">
        {% if product.tags contains 'popular' %}
          <div class="product-badge product-badge--popular">MÁS VENDIDO</div>
        {% endif %}
        
        <h1 class="product-title">{{ product.title }}</h1>
        
        <div class="product-price">
          <span class="product-price-current">{{ product.price | money }}</span>
          {% if product.compare_at_price > product.price %}
            <span class="product-price-original">{{ product.compare_at_price | money }}</span>
            {% assign discount = product.compare_at_price | minus: product.price | times: 100 | divided_by: product.compare_at_price %}
            <span class="product-discount">-{{ discount }}% descuento</span>
          {% endif %}
        </div>

        <div class="product-stock">
          {% if product.available %}
            <span class="product-stock-badge product-stock-badge--in-stock">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 12l2 2 4-4"></path>
                <circle cx="12" cy="12" r="10"></circle>
              </svg>
              En Stock - Envío inmediato
            </span>
          {% else %}
            <span class="product-stock-badge product-stock-badge--out-of-stock">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
              </svg>
              Agotado
            </span>
          {% endif %}
        </div>

        {% if product.description != blank %}
          <div class="product-description">
            {{ product.description }}
          </div>
        {% endif %}

        <!-- Features -->
        {% if product.metafields.custom.features %}
          <div class="product-features">
            <h3 class="product-features-title">Características principales:</h3>
            <ul class="product-features-list">
              {% assign features = product.metafields.custom.features | split: ',' %}
              {% for feature in features %}
                <li class="product-feature">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 12l2 2 4-4"></path>
                    <circle cx="12" cy="12" r="10"></circle>
                  </svg>
                  {{ feature | strip }}
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        <!-- Add to Cart Form -->
        <form action="/cart/add" method="post" enctype="multipart/form-data" class="product-form">
          <div class="product-form-buttons">
            {% if product.available %}
              <div class="product-quantity">
                <label for="quantity" class="product-quantity-label">Cantidad:</label>
                <div class="product-quantity-controls">
                  <button type="button" class="quantity-btn quantity-minus" onclick="changeQuantity(-1)">-</button>
                  <input type="number" id="quantity" name="quantity" value="1" min="1" class="quantity-input">
                  <button type="button" class="quantity-btn quantity-plus" onclick="changeQuantity(1)">+</button>
                </div>
              </div>
              
              <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
              
              <button type="submit" class="product-add-to-cart">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                  <line x1="3" y1="6" x2="21" y2="6"></line>
                  <path d="M16 10a4 4 0 0 1-8 0"></path>
                </svg>
                Añadir al Carrito - {{ product.price | money }}
              </button>
            {% else %}
              <button type="button" class="product-add-to-cart product-add-to-cart--disabled" disabled>
                Producto Agotado
              </button>
            {% endif %}
          </div>
        </form>

        <!-- Trust Badges -->
        <div class="product-trust-badges">
          <div class="trust-badge">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
            </svg>
            <span>Homologado DGT</span>
          </div>
          <div class="trust-badge">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
              <polyline points="3.27,6.96 12,12.01 20.73,6.96"></polyline>
              <line x1="12" y1="22.08" x2="12" y2="12"></line>
            </svg>
            <span>Envío gratuito >100€</span>
          </div>
          <div class="trust-badge">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 12l2 2 4-4"></path>
              <circle cx="12" cy="12" r="10"></circle>
            </svg>
            <span>Garantía 2 años</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function changeMainImage(imageUrl) {
  const mainImage = document.querySelector('.product-image-primary');
  if (mainImage) {
    mainImage.src = imageUrl;
  }
  
  // Update active thumbnail
  document.querySelectorAll('.product-thumbnail').forEach(thumb => {
    thumb.classList.remove('active');
  });
  event.target.closest('.product-thumbnail').classList.add('active');
}

function changeQuantity(delta) {
  const quantityInput = document.getElementById('quantity');
  const currentValue = parseInt(quantityInput.value);
  const newValue = Math.max(1, currentValue + delta);
  quantityInput.value = newValue;
}

// Add to cart functionality
document.querySelector('.product-form').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  
  fetch('/cart/add.js', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    // Show success message or update cart
    console.log('Product added to cart:', data);
    
    // Update cart count in header
    updateCartCount();
    
    // Show notification
    showNotification('Producto añadido al carrito');
  })
  .catch(error => {
    console.error('Error adding to cart:', error);
    showNotification('Error al añadir el producto', 'error');
  });
});

function updateCartCount() {
  fetch('/cart.js')
    .then(response => response.json())
    .then(cart => {
      const cartCount = document.querySelector('.header__cart-count');
      if (cartCount) {
        cartCount.textContent = cart.item_count;
        cartCount.style.display = cart.item_count > 0 ? 'block' : 'none';
      }
    });
}

function showNotification(message, type = 'success') {
  // Create and show notification
  const notification = document.createElement('div');
  notification.className = `notification notification--${type}`;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 3000);
}
</script>